<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,500;0,700;0,800;1,300;1,400;1,500;1,700;1,800&display=swap" rel="stylesheet">
    <!-- CSS -->
    <link rel="stylesheet" href="index.css" />
  </head>
  <body>
    <div id="title">
      <h1>d.camp 2020 Dashboard</h1>
    </div>
    <div id="contents">
      <div id="moodChecker">
        <h2 class="subtitle">Mood Checker</h2>
        <div class="slidecontainer">
          <p id="emoji">&#128518;</p>
          <input type="range" min="1" max="100" value="50" id="slider">
          <p id="sliderValue"></p>
        </div>
      </div>
      <div id="highFive">
        <h2 class="subtitle">Remote High Five</h2>
        <video id="video"></video>
        <canvas id="canvas" class="border"></canvas>
        <button onclick="toggleVideo()" id="toggleButton" type="button">
          Toggle Video
        </button>
      </div>
    </div>
    <div id="bottomMargin"></div>
  </body>
  <!-- Load the handtrackjs model. -->
  <script src="https://cdn.jsdelivr.net/npm/handtrackjs/dist/handtrack.min.js"> </script>
  <!-- Load the Howler.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.0/howler.min.js"></script>
  <!--Socket IO.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
  <script>
    /**************
    Send Socket IO
    **************/

    var socket = io('https://dcamptokyo2020.herokuapp.com/');
    socket.on('connect', function(){
      console.log("connected to Socket IO!");
    });

    var slider = document.getElementById('slider');
    var sliderValue = document.getElementById('sliderValue');
    var emoji = document.getElementById('emoji');

    slider.addEventListener('input', function () {
      sliderValue.innerHTML = slider.value
      socket.emit('mood',slider.value)
      if(slider.value < 20) emoji.innerHTML = "&#128565;"
      else if(slider.value >= 20 && slider.value < 40) emoji.innerHTML = "&#128547;"
      else if(slider.value >= 40 && slider.value < 60) emoji.innerHTML = "&#128528;"
      else if(slider.value >= 60 && slider.value < 80) emoji.innerHTML = "&#128513;"
      else if(slider.value >= 80 && slider.value <= 100) emoji.innerHTML = "&#128514;"
    }, false);

    // function sendMessage() {
    //     console.log(document.getElementById("chat-input").value)
    //     socket.emit('message',document.getElementById("chat-input").value)
    // }
    // socket.on("new_message", (data) => {
    //   document.getElementById("chat").innerHTML += "<br>" + data
    // })

    /**************
    HandTrack.js
    **************/
    var isVideo = false;
    var model = null;
    const modelParams = {
        flipHorizontal: false,   // flip e.g for video
        maxNumBoxes: 10,        // maximum number of boxes to detect
        iouThreshold: 0.5,      // ioU threshold for non-max suppression
        scoreThreshold: 0.6,    // confidence threshold for predictions.
    }
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    var toggleButton = document.getElementById("toggleButton");
    var myHandPos;
    var handPos = [
      [0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [0, 0],
      [0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [0, 0]
    ];
    var color = ['red', 'blue', 'green', 'yellow', 'orange', 'pink', 'purple', 'grey', 'black', 'brown', 'cyan', 'Lavender']
    var soundPlaying = false;
    var sound = new Howl({
      src: ['highfive.mp3'],
      volume: 0.5,
      onplay: function() {
        console.log('Sound started!');
        soundPlaying = true;
      },
      onend: function() {
        console.log('Sound Finished!');
        soundPlaying = false;
      }
    });

    function toggleVideo() {
        if (!isVideo) {
            startVideo();
        } else {
            handTrack.stopVideo(video)
            isVideo = false;
        }
    }

    function startVideo() {
        handTrack.startVideo(video).then(function (status) {
            console.log("video started", status);
            if (status) {
                isVideo = true
                runDetection()
            }
        });
    }

    function runDetection() {
        model.detect(video).then(predictions => {
            try{
              myHandPos = {
                x:predictions[0].bbox[0],
                y:predictions[0].bbox[1],
                width:predictions[0].bbox[2],
                height:predictions[0].bbox[3]
              };
              //console.log("Predictions: ", myHandPos.x, " ", myHandPos.y, " ", myHandPos.width, " ", myHandPos.height);
              socket.emit('handPosition', myHandPos);
            }
            catch(error) {
              console.error(error);
            }
            model.renderPredictions(predictions, canvas, context, video);
            if (isVideo) {
                requestAnimationFrame(runDetection);
            }
        });
    }

    // Load the model.
    handTrack.load(modelParams).then(lmodel => {
        // detect objects in the image.
        model = lmodel
        toggleButton.disabled = false
    });

    socket.on("new_handPosition", (data) => {
      if(isVideo){
        var obj = JSON.parse(data)
        var index = obj.clients.indexOf(obj.from)
        handPos[index][0] = obj.content.x + (obj.content.width / 2)
        handPos[index][1] = obj.content.y + (obj.content.height / 2)

        for(var i=0; i<handPos.length; i++){
          context.beginPath();
          context.arc(handPos[i][0], handPos[i][1], 10, 0, 2 * Math.PI);
          context.fillStyle = color[i];
          context.fill();

          let myHandPosCenterX = (myHandPos.x + (myHandPos.width/2))
          let myHandPosCenterY = (myHandPos.y + (myHandPos.height/2))
          let compHandPosCenterX = (obj.content.x + (obj.content.width/2))
          let compHandPosCenterY = (obj.content.y + (obj.content.height/2))

          if(Math.sqrt(Math.pow((myHandPosCenterX - compHandPosCenterX),2) + Math.pow((myHandPosCenterY - compHandPosCenterY),2)) < 10 &&
          Math.sqrt(Math.pow((myHandPosCenterX - compHandPosCenterX),2) + Math.pow((myHandPosCenterY - compHandPosCenterY),2)) > 5 ){
            console.log(Math.sqrt(Math.pow((myHandPosCenterX - compHandPosCenterX),2) + Math.pow((myHandPosCenterY - compHandPosCenterY),2)));
            if(soundPlaying == false){
                sound.play();
            }
          }
        }
      }
    })

  </script>
</html>
